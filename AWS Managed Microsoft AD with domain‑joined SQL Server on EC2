AWSTemplateFormatVersion: '2010-09-09'
Description: >
  Provision AWS Managed Microsoft AD and a domain-joined Windows EC2 for SQL Server.
  Includes parameters for VPC, private subnets, security group, SSH key, KMS encryption,
  volume configuration, environment tagging, and IAM roles (Instance Profile + AmazonSSMDirectoryServiceAccess).

Parameters:
  EnvironmentTag:
    Type: String
    Default: Dev
    AllowedValues: [Dev, Test, Prod]
    Description: Environment tag applied to all resources

  # Networking
  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: VPC where the directory and EC2 will be deployed
  PrivateSubnet1Id:
    Type: AWS::EC2::Subnet::Id
    Description: First private subnet (AZ-A) for Directory Service and EC2
  PrivateSubnet2Id:
    Type: AWS::EC2::Subnet::Id
    Description: Second private subnet (AZ-B) for Directory Service (required)
  SecurityGroupId:
    Type: AWS::EC2::SecurityGroup::Id
    Description: Security group ID for the EC2 instance (allow RDP/WinRM if needed)

  # Directory Service
  DirectoryEdition:
    Type: String
    Default: Standard
    AllowedValues: [Standard, Enterprise]
    Description: AWS Managed Microsoft AD edition
  DirectoryName:
    Type: String
    Description: Fully qualified domain name (e.g., corp.example.com)
  DirectoryShortName:
    Type: String
    Description: NetBIOS short name (e.g., CORP)
  DirectoryAdminPasswordSecretArn:
    Type: String
    Description: ARN of Secrets Manager secret containing 'password' for Directory admin

  # EC2 configuration
  InstanceType:
    Type: String
    Default: t3.large
    Description: EC2 instance type for SQL Server
  KeyName:
    Type: AWS::EC2::KeyPair::KeyName
    Description: Existing EC2 KeyPair name for RDP access (optional)
    Default: ""
  AmiId:
    Type: String
    Description: Windows Server 2019/2022 AMI (optionally with SQL Server preinstalled)
    Default: ""
  RootVolumeSizeGiB:
    Type: Number
    Default: 100
    MinValue: 50
    Description: Root EBS volume size in GiB
  RootVolumeType:
    Type: String
    Default: gp3
    AllowedValues: [gp3, gp2, io1, io2, st1, sc1]
    Description: Root EBS volume type
  KmsKeyId:
    Type: String
    Description: KMS Key ID or ARN for EBS volume encryption

  # Optional tagging
  CostCenterTag:
    Type: String
    Default: ''
    Description: Optional cost center tag
  OwnerTag:
    Type: String
    Default: ''
    Description: Optional owner tag (email or team)

Conditions:
  HasKeyName: !Not [!Equals [!Ref KeyName, ""]]
  HasAmiOverride: !Not [!Equals [!Ref AmiId, ""]]
  HasCostCenter: !Not [!Equals [!Ref CostCenterTag, ""]]
  HasOwner: !Not [!Equals [!Ref OwnerTag, ""]]

Resources:
  ############################################
  # AWS Managed Microsoft AD (multi-AZ)
  ############################################
  ManagedDirectory:
    Type: AWS::DirectoryService::MicrosoftAD
    Properties:
      Name: !Ref DirectoryName
      ShortName: !Ref DirectoryShortName
      Password: !Sub "{{resolve:secretsmanager:${DirectoryAdminPasswordSecretArn}:SecretString:password}}"
      Edition: !Ref DirectoryEdition
      VpcSettings:
        VpcId: !Ref VpcId
        SubnetIds:
          - !Ref PrivateSubnet1Id
          - !Ref PrivateSubnet2Id
      Tags:
        - Key: Name
          Value: !Sub "AD-${EnvironmentTag}"
        - Key: Environment
          Value: !Ref EnvironmentTag
        - Key: CostCenter
          Value: !If [HasCostCenter, !Ref CostCenterTag, !Ref 'AWS::NoValue']
        - Key: Owner
          Value: !If [HasOwner, !Ref OwnerTag, !Ref 'AWS::NoValue']

  ############################################
  # IAM role and instance profile for EC2
  ############################################
  EC2Role:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "EC2-SQL-DirJoin-${EnvironmentTag}"
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: { Service: ec2.amazonaws.com }
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
        - arn:aws:iam::aws:policy/AmazonSSMDirectoryServiceAccess
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentTag

  EC2InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles: [!Ref EC2Role]

  ############################################
  # EC2 Windows instance (domain-joined) for SQL Server
  ############################################
  SqlServerInstance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: !Ref InstanceType
      IamInstanceProfile: !Ref EC2InstanceProfile
      SubnetId: !Ref PrivateSubnet1Id
      SecurityGroupIds: [!Ref SecurityGroupId]
      ImageId: !If
        - HasAmiOverride
        - !Ref AmiId
        - !Ref AWS::NoValue
      KeyName: !If [HasKeyName, !Ref KeyName, !Ref 'AWS::NoValue']
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            Encrypted: true
            KmsKeyId: !Ref KmsKeyId
            VolumeSize: !Ref RootVolumeSizeGiB
            VolumeType: !Ref RootVolumeType
      Tags:
        - Key: Name
          Value: !Sub "SQLServer-${EnvironmentTag}"
        - Key: Environment
          Value: !Ref EnvironmentTag
        - Key: CostCenter
          Value: !If [HasCostCenter, !Ref CostCenterTag, !Ref 'AWS::NoValue']
        - Key: Owner
          Value: !If [HasOwner, !Ref OwnerTag, !Ref 'AWS::NoValue']
      UserData:
        Fn::Base64: !Sub |
          <powershell>
          # Harden basics
          Set-ExecutionPolicy RemoteSigned -Force

          # Install Chocolatey
          iex ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))

          # Install SQL Server Management Studio (SSMS)
          choco install sql-server-management-studio -y --no-progress

          # Optional: Windows Firewall rules for SQL Server (default port 1433)
          New-NetFirewallRule -DisplayName "Allow SQL Server 1433" -Direction Inbound -Protocol TCP -LocalPort 1433 -Action Allow

          # Signal completion in the EC2 console log
          Write-Output "SSMS installed. Awaiting domain join via SSM association."
          </powershell>

  ############################################
  # SSM association to join domain
  ############################################
  JoinDomainAssociation:
    Type: AWS::SSM::Association
    Properties:
      Name: AWS-JoinDirectoryServiceDomain
      AssociationName: !Sub "JoinDomain-${EnvironmentTag}"
      Targets:
        - Key: InstanceIds
          Values:
            - !Ref SqlServerInstance
      Parameters:
        directoryId:
          - !Ref ManagedDirectory
        directoryName:
          - !Ref DirectoryName
        userName:
          - !Sub "${DirectoryShortName}\\Admin"
        password:
          - !Sub "{{resolve:secretsmanager:${DirectoryAdminPasswordSecretArn}:SecretString:password}}"
        # Optional OU path example: OU=Servers,OU=Cloud,DC=corp,DC=example,DC=com
        # specifyOU:
        #   - "OU=Servers,OU=Cloud,DC=corp,DC=example,DC=com"
      ScheduleExpression: rate(1 day) # runs immediately then as a safety net
      AutomationTargetParameterName: InstanceId

Outputs:
  DirectoryId:
    Description: AWS Managed Microsoft AD Directory ID
    Value: !Ref ManagedDirectory
  DirectoryNameOut:
    Description: Directory DNS name
    Value: !GetAtt ManagedDirectory.Name
  SqlServerInstanceId:
    Description: EC2 instance ID
    Value: !Ref SqlServerInstance
  SqlServerPrivateIp:
    Description: EC2 private IP
    Value: !GetAtt SqlServerInstance.PrivateIp
