AWSTemplateFormatVersion: '2010-09-09'
Description: VPC with private subnets across up to 6 AZs, Flow Logs, DHCP options, route tables, and Transit Gateway attachment

Parameters:
  VpcCidr:
    Type: String
    Default: 10.0.0.0/16
    Description: CIDR block for the VPC

  NumberOfAZs:
    Type: Number
    Default: 2
    MinValue: 2
    MaxValue: 6
    Description: Number of Availability Zones to use

  EnvironmentTag:
    Type: String
    Default: Dev
    AllowedValues: [Dev, Test, Prod]
    Description: Environment tag

  TransitGatewayId:
    Type: String
    Description: Existing Transit Gateway ID to attach the VPC

  FlowLogsBucketName:
    Type: String
    Description: S3 bucket name for VPC Flow Logs

Resources:

  ## VPC
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentTag}-VPC"
        - Key: Environment
          Value: !Ref EnvironmentTag

  ## DHCP Options
  DhcpOptions:
    Type: AWS::EC2::DHCPOptions
    Properties:
      DomainName: !Sub "${EnvironmentTag}.local"
      DomainNameServers:
        - AmazonProvidedDNS
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentTag}-DHCPOptions"

  VPCDHCPOptionsAssociation:
    Type: AWS::EC2::VPCDHCPOptionsAssociation
    Properties:
      VpcId: !Ref VPC
      DhcpOptionsId: !Ref DhcpOptions

  ## Private Subnets (up to 6 AZs)
  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.1.0/24
      AvailabilityZone: !Select [0, !GetAZs ""]
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentTag}-PrivateSubnet-AZ1"

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Condition: UseAZ2
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.2.0/24
      AvailabilityZone: !Select [1, !GetAZs ""]
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentTag}-PrivateSubnet-AZ2"

  PrivateSubnet3:
    Type: AWS::EC2::Subnet
    Condition: UseAZ3
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.3.0/24
      AvailabilityZone: !Select [2, !GetAZs ""]
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentTag}-PrivateSubnet-AZ3"

  PrivateSubnet4:
    Type: AWS::EC2::Subnet
    Condition: UseAZ4
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.4.0/24
      AvailabilityZone: !Select [3, !GetAZs ""]
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentTag}-PrivateSubnet-AZ4"

  PrivateSubnet5:
    Type: AWS::EC2::Subnet
    Condition: UseAZ5
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.5.0/24
      AvailabilityZone: !Select [4, !GetAZs ""]
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentTag}-PrivateSubnet-AZ5"

  PrivateSubnet6:
    Type: AWS::EC2::Subnet
    Condition: UseAZ6
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.6.0/24
      AvailabilityZone: !Select [5, !GetAZs ""]
      MapPublicIpOnLaunch: false
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentTag}-PrivateSubnet-AZ6"

  ## Route Table
  PrivateRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentTag}-PrivateRouteTable"

  ## Route Table Associations
  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref PrivateRouteTable

  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: UseAZ2
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTable

  PrivateSubnet3RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: UseAZ3
    Properties:
      SubnetId: !Ref PrivateSubnet3
      RouteTableId: !Ref PrivateRouteTable

  PrivateSubnet4RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: UseAZ4
    Properties:
      SubnetId: !Ref PrivateSubnet4
      RouteTableId: !Ref PrivateRouteTable

  PrivateSubnet5RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: UseAZ5
    Properties:
      SubnetId: !Ref PrivateSubnet5
      RouteTableId: !Ref PrivateRouteTable

  PrivateSubnet6RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: UseAZ6
    Properties:
      SubnetId: !Ref PrivateSubnet6
      RouteTableId: !Ref PrivateRouteTable

  ## Transit Gateway Attachment
  TransitGatewayAttachment:
    Type: AWS::EC2::TransitGatewayAttachment
    Properties:
      TransitGatewayId: !Ref TransitGatewayId
      VpcId: !Ref VPC
      SubnetIds:
        - !Ref PrivateSubnet1
        - !If [UseAZ2, !Ref PrivateSubnet2, !Ref "AWS::NoValue"]
        - !If [UseAZ3, !Ref PrivateSubnet3, !Ref "AWS::NoValue"]
        - !If [UseAZ4, !Ref PrivateSubnet4, !Ref "AWS::NoValue"]
        - !If [UseAZ5, !Ref PrivateSubnet5, !Ref "AWS::NoValue"]
        - !If [UseAZ6, !Ref PrivateSubnet6, !Ref "AWS::NoValue"]
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentTag}-TGW-Attachment"

  ## Flow Logs IAM Role
  FlowLogsRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: vpc-flow-logs.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: FlowLogsS3Policy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action: s3:PutObject
                Resource: !Sub "arn:aws:s3:::${FlowLogsBucketName}/*"

  ## VPC Flow Logs
  VPCFlowLogs:
    Type: AWS::EC2::FlowLog
    Properties:
      DeliverLogsPermissionArn: !GetAtt FlowLogsRole.Arn
      LogDestinationType: s3
      LogDestination: !Sub "arn:aws:s3:::${FlowLogsBucketName}"
      ResourceId: !Ref VPC
      ResourceType: VPC
      TrafficType: ALL
      Tags:
        - Key: Name
          Value: !Sub "${EnvironmentTag}-VPCFlowLogs"

Conditions:
  UseAZ2: !Or [!Equals [!Ref NumberOfAZs, 2], !Equals [!Ref NumberOfAZs, 3], !Equals [!Ref NumberOfAZs, 4], !Equals [!Ref NumberOfAZs, 5], !Equals [!Ref NumberOfAZs, 6]]
  UseAZ3: !Or [!Equals [!Ref NumberOfAZs, 3], !Equals [!Ref NumberOfAZs, 4], !Equals [
