import boto3
import os
from datetime import datetime

region = 'us-east-2'
ec2_resource = boto3.resource('ec2', region_name=region)
ec2_client = boto3.client('ec2', region_name=region)

def lambda_handler(event, context):
    # Current time in HH:MM format
    current_time = datetime.now().strftime("%H:%M")

    turn_on_instance_list = []
    turn_off_instance_list = []

    for instance in ec2_resource.instances.all():
        if not instance.tags:
            continue

        schedule_flag = None
        turn_on_flag = None
        turn_off_flag = None

        # Parse tags
        for tag in instance.tags:
            key = tag['Key'].lower()
            value = tag['Value']

            if key == 'automatic schedule':
                schedule_flag = value
            elif key == 'turn on':
                turn_on_flag = value
            elif key == 'turn off':
                turn_off_flag = value

        # Check environment override (default Disabled)
        schedule_flag = os.environ.get('SCHEDULE_FLAG', schedule_flag or 'Disabled')

        if schedule_flag.lower() == 'enabled':
            if turn_on_flag and current_time == turn_on_flag:
                turn_on_instance_list.append(instance.id)
            if turn_off_flag and current_time == turn_off_flag:
                turn_off_instance_list.append(instance.id)

    # Start/Stop instances
    if turn_on_instance_list:
        ec2_client.start_instances(InstanceIds=turn_on_instance_list)
        print(f"EC2 Instances started: {turn_on_instance_list}")

    if turn_off_instance_list:
        ec2_client.stop_instances(InstanceIds=turn_off_instance_list)
        print(f"EC2 Instances stopped: {turn_off_instance_list}")

    return {
        "statusCode": 200,
        "body": f"Started: {turn_on_instance_list}, Stopped: {turn_off_instance_list}"
    }
